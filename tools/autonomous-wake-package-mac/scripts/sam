#!/bin/bash
# sam - Quick task creation for AI Companion
#
# Usage:
#   sam "research topic X"           # Create a research task
#   sam -p high "urgent thing"       # High priority task
#   sam -t content "optimize post"   # Specific task type
#   sam status                       # Show pending tasks
#   sam log                          # Show today's journal
#
# This creates task files that your AI processes on the next wake-up.

set -euo pipefail

# Configuration
AI_COMPANION_PATH="${AI_COMPANION_PATH:-$HOME/AI-Companion}"
TASKS_DIR="$AI_COMPANION_PATH/tasks/pending"
JOURNAL_DIR="$AI_COMPANION_PATH/journal"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Defaults
PRIORITY="medium"
TASK_TYPE="general"

show_help() {
    echo -e "${BLUE}sam${NC} - Autonomous Agent Command Line Interface"
    echo ""
    echo -e "${YELLOW}Usage:${NC}"
    echo "  sam <command> [arguments]"
    echo "  sam \"quick task description\""
    echo ""
    echo -e "${YELLOW}Commands:${NC}"
    echo -e "  ${GREEN}Task Management:${NC}"
    echo "    sam \"description\"            Create a new task with 'medium' priority"
    echo "    sam -p urgent \"desc\"         Create task with 'urgent' priority (low/medium/high/urgent)"
    echo "    sam -t research \"desc\"       Create task with 'research' type (general/content/analysis)"
    echo "    sam status                    Show pending tasks and inputs awaiting decision"
    echo ""
    echo -e "  ${GREEN}System & Logs:${NC}"
    echo "    sam wake                      Trigger an immediate autonomous wake-up cycle"
    echo "    sam log                       Read today's journal entry"
    echo "    sam help                      Show this help message"
    echo ""
    echo -e "  ${GREEN}Security & Permissions:${NC}"
    echo "    sam permissions               List current allowed/denied paths"
    echo "    sam allow <path>              Grant read/write access to a specific path"
    echo "    sam deny <path>               Revoke access to a specific path"
    echo ""
    echo -e "  ${GREEN}Tool Fabrication (Human-in-the-Loop):${NC}"
    echo "    sam tool list                 Show pending tool creation requests from SAM"
    echo "    sam tool approve <name>       Approve a tool request (SAM will build it next cycle)"
    echo "    sam tool deny <name>          Deny a tool request (Blacklist)"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "    sam \"Research the history of sourdough\""
    echo "    sam -p high \"Draft Q3 report based on N8N data\""
    echo "    sam tool approve get-crypto-price"
    echo "    sam log"
}

show_status() {
    echo -e "${BLUE}=== AI Companion Status ===${NC}"
    echo ""

    # Count tasks
    local pending=$(find "$TASKS_DIR" -name "*.json" 2>/dev/null | wc -l | tr -d ' ')
    local completed=$(find "$AI_COMPANION_PATH/tasks/completed" -name "*.json" 2>/dev/null | wc -l | tr -d ' ')
    local awaiting=$(find "$AI_COMPANION_PATH/tasks/awaiting-input" -name "*.json" 2>/dev/null | wc -l | tr -d ' ')

    echo -e "Pending tasks:        ${YELLOW}$pending${NC}"
    echo -e "Completed today:      ${GREEN}$completed${NC}"
    echo -e "Awaiting your input:  ${CYAN}$awaiting${NC}"
    echo ""

    if [[ "$pending" -gt 0 ]]; then
        echo -e "${BLUE}Pending Tasks:${NC}"
        for f in "$TASKS_DIR"/*.json; do
            if [[ -f "$f" ]]; then
                local id=$(jq -r '.id // "unknown"' "$f" 2>/dev/null)
                local type=$(jq -r '.type // "general"' "$f" 2>/dev/null)
                local priority=$(jq -r '.priority // "medium"' "$f" 2>/dev/null)
                local instructions=$(jq -r '.instructions // ""' "$f" 2>/dev/null | head -c 60)

                local pcolor="$NC"
                case "$priority" in
                    urgent) pcolor="$RED" ;;
                    high) pcolor="$YELLOW" ;;
                esac

                echo -e "  ${pcolor}[$priority]${NC} $type: $instructions..."
            fi
        done
    fi

    if [[ "$awaiting" -gt 0 ]]; then
        echo ""
        echo -e "${CYAN}Awaiting Your Input:${NC}"
        for f in "$AI_COMPANION_PATH/tasks/awaiting-input"/*.json; do
            if [[ -f "$f" ]]; then
                local instructions=$(jq -r '.instructions // ""' "$f" 2>/dev/null | head -c 60)
                local result=$(jq -r '.result // ""' "$f" 2>/dev/null | head -c 80)
                echo "  - $instructions..."
                if [[ -n "$result" ]]; then
                    echo "    AI says: $result..."
                fi
            fi
        done
    fi
}

show_log() {
    local today=$(date +%Y-%m-%d)
    local journal_file="$JOURNAL_DIR/$today.md"

    if [[ -f "$journal_file" ]]; then
        echo -e "${BLUE}=== Journal: $today ===${NC}"
        echo ""
        cat "$journal_file"
    else
        echo -e "${YELLOW}No journal entry for today yet.${NC}"
        echo "Your AI will create one on its next wake-up."
    fi
}

trigger_wake() {
    local wakeup_script="$AI_COMPANION_PATH/wakeup.sh"

    if [[ -x "$wakeup_script" ]]; then
        echo -e "${CYAN}Triggering immediate wake-up...${NC}"
        "$wakeup_script"
    else
        echo -e "${RED}Wake-up script not found at: $wakeup_script${NC}"
        exit 1
    fi
}

create_task() {
    local instructions="$1"
    local task_id="sam-$(date +%s)-$(head -c 4 /dev/urandom | xxd -p)"
    local created=$(date -u +%Y-%m-%dT%H:%M:%SZ)
    local filename="$TASKS_DIR/$task_id.json"

    # Ensure directory exists
    mkdir -p "$TASKS_DIR"

    # Determine tools based on type
    local tools='["WebSearch", "Read", "Write"]'
    case "$TASK_TYPE" in
        research)
            tools='["WebSearch", "Read", "Write"]'
            ;;
        content)
            tools='["Read", "Write", "Edit", "WebSearch"]'
            ;;
        analysis)
            tools='["Read", "WebSearch", "Write"]'
            ;;
    esac

    # Create task JSON
    cat > "$filename" << EOF
{
  "id": "$task_id",
  "type": "$TASK_TYPE",
  "priority": "$PRIORITY",
  "created": "$created",
  "source": "sam-cli",
  "context": {
    "created_by": "manual",
    "cli_version": "1.0"
  },
  "instructions": "$instructions",
  "tools_allowed": $tools,
  "result": null,
  "status": "pending",
  "completed_at": null
}
EOF

    echo -e "${GREEN}✓${NC} Task created: $task_id"
    echo -e "  Priority: ${YELLOW}$PRIORITY${NC}"
    echo -e "  Type: $TASK_TYPE"
    echo -e "  Instructions: $instructions"
    echo ""
    echo "Task will be processed on the next wake-up."
    echo -e "Run ${CYAN}sam wake${NC} to process immediately."
}

# === PERMISSIONS ===
SETTINGS_FILE="$AI_COMPANION_PATH/.claude/settings.local.json"

check_jq() {
    if ! command -v jq &> /dev/null; then
        echo -e "${RED}Error: 'jq' is required for permission management.${NC}"
        echo "Please install it: brew install jq"
        exit 1
    fi
}

init_settings() {
    if [[ ! -f "$SETTINGS_FILE" ]]; then
        mkdir -p "$(dirname "$SETTINGS_FILE")"
        echo '{"permissions":{"allow":[],"deny":[]}}' > "$SETTINGS_FILE"
    fi
}

add_permission() {
    local type="$1" # allow or deny
    local path="$2"
    
    check_jq
    init_settings
    
    if [[ -z "$path" ]]; then
        echo -e "${RED}Error: Please specify a path.${NC}"
        exit 1
    fi

    local temp_file=$(mktemp)
    
    # Add path to array if not exists
    jq --arg path "$path" --arg type "$type" \
       '.permissions[$type] += [$path] | .permissions[$type] |= unique' \
       "$SETTINGS_FILE" > "$temp_file" && mv "$temp_file" "$SETTINGS_FILE"
       
    echo -e "${GREEN}✓${NC} Added '$path' to $type list."
}

list_permissions() {
    check_jq
    init_settings
    
    echo -e "${BLUE}=== Current Permissions ===${NC}"
    echo ""
    echo -e "${GREEN}Allowed:${NC}"
    jq -r '.permissions.allow[] | "  - \(.)"' "$SETTINGS_FILE" 2>/dev/null || echo "  (none)"
    echo ""
    echo -e "${RED}Denied:${NC}"
    jq -r '.permissions.deny[] | "  - \(.)"' "$SETTINGS_FILE" 2>/dev/null || echo "  (none)"
    echo ""
}

# === TOOL FABRICATION ===
REQUESTS_DIR="$AI_COMPANION_PATH/requests"

list_tools() {
    echo -e "${BLUE}=== Tool Requests ===${NC}"
    echo ""
    local pending=$(find "$REQUESTS_DIR/pending" -name "*.json" 2>/dev/null | wc -l | tr -d ' ')

    if [[ "$pending" -eq 0 ]]; then
        echo "No pending tool requests."
        return
    fi

    for f in "$REQUESTS_DIR/pending"/*.json; do
        if [[ -f "$f" ]]; then
            local name=$(jq -r '.name // "unknown"' "$f" 2>/dev/null)
            local purpose=$(jq -r '.purpose // "unknown"' "$f" 2>/dev/null)
            local access=$(jq -r '.access_required | join(", ")' "$f" 2>/dev/null)
            
            echo -e "${YELLOW}Name:${NC} $name"
            echo -e "  Purpose: $purpose"
            echo -e "  Access: $access"
            echo -e "  Run: ${CYAN}sam tool approve $name${NC} or ${RED}sam tool deny $name${NC}"
            echo ""
        fi
    done
}

manage_tool() {
    local action="$1"
    local name="$2"
    local src="$REQUESTS_DIR/pending/${name}.json"

    if [[ ! -f "$src" ]]; then
        echo -e "${RED}Error: Tool request '$name' not found.${NC}"
        return
    fi

    if [[ "$action" == "approve" ]]; then
        mv "$src" "$REQUESTS_DIR/approved/"
        echo -e "${GREEN}✓${NC} Tool '$name' APPROVED. SAM will build it on next wake-up."
    elif [[ "$action" == "deny" ]]; then
        mv "$src" "$REQUESTS_DIR/denied/"
        echo -e "${RED}✗${NC} Tool '$name' DENIED."
    fi
}

tool_command() {
    local cmd="$1"
    shift
    
    case "$cmd" in
        list) list_tools ;;
        approve) manage_tool "approve" "$1" ;;
        deny) manage_tool "deny" "$1" ;;
        *) echo "Usage: sam tool [list|approve|deny <name>]" ;;
    esac
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -p|--priority)
            PRIORITY="$2"
            shift 2
            ;;
        -t|--type)
            TASK_TYPE="$2"
            shift 2
            ;;
        help|--help|-h)
            show_help
            exit 0
            ;;
        status)
            show_status
            exit 0
            ;;
        log|journal)
            show_log
            exit 0
            ;;
        wake|wakeup)
            trigger_wake
            exit 0
            ;;
        allow)
            add_permission "allow" "$2"
            exit 0
            ;;
        deny)
            add_permission "deny" "$2"
            exit 0
            ;;
        permissions|perms)
            list_permissions
            exit 0
            ;;
        tool)
            shift
            tool_command "$@"
            exit 0
            ;;
        *)
            # This is the task description
            if [[ -n "$1" ]]; then
                create_task "$1"
                exit 0
            fi
            ;;
    esac
done

# No arguments - show help
show_help
